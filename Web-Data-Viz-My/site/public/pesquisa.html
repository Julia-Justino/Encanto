<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/stylePesquisa.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="https://images.emojiterra.com/google/android-11/512px/1f308.png" />
    <title>Pesquisa | Encanto </title>
</head>

<body>
    <!--Inicio do navbar-->
    <div class="header">
        <div class="container">

            <ul class="navbar">
                <li><a href="#blog">Blog</a></li>
                <li><a href="#votacao">Votação</a></li>
                <li><a href="#pesquisa">Sobre</a></li>
                <li><a href="#resultados">Resultados</a></li>
            </ul>
        </div>
        <!--Final do navbar-->
        <hr>
        <!--Inicio do banner-->
        <div class="banner">
            <div class="container">
                <h1><img src="./assets/img/logoSimples-removebg-preview.png"
                        alt="Está escrito na imagem: Encanto, a arte de contar histórias. "></h1>
            </div>
        </div>
        <!--Final do banner-->
    </div>
    <!-- Final do header-->
    <!--Inicio do blog-->
    <section class="blogEncanto">

        <div class="blog" id="blog">
            <section class="formPesquisa">
                <div class="form" id="geral">
                    <h2>Formulário de pesquisa</h2>
                    <p>Genêro favorito:</p>
                    <input type="text" name="" id="inp_genero" placeholder="Ex: Drama.">
                    <p>Autor favorito do genêro:</p>
                    <input type="text" name="" id="inp_autor" placeholder="Ex: Neil Gaiman.">
                    <p>Quantos livros leiu mensalmente:</p>
                    <input type="number" name="" id="inp_qtd" placeholder="Ex: 5 livros.">
                    <br>
                    <button class="enviar" onclick="cadastrar()">Enviar</button>

                </div>
            </section>
            <!--finalda div form para pesquisa-->
            <div class="container" id="votacao">

                <div class="tituloBlog">
                    <h1><img src="./assets/img/pesquisa.png" alt=""></h1>
                </div>
                <div class="textoBlog">
                    <div class="subTituloBlog">

                    </div>

                    <div class="texto">
                        <p>
                            Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has
                            been the industry's standard dummy text ever since the 1500s, when an unknown printer took.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!--Final do blog-->
        <!--Inicio da div form para pesquisa-->
        <!--Inicio da pesquisa-->
        <div class="pesquisa" id="pesquisa">
            <div id="container">
                <div class="titulo">
                    <h1><img src="./assets/img/pesquisa.png" alt=""></h1>
                    <div class="textoConheca">
                        <p>A pesquisa é uma ferramenta valiosa para entender a audiência e ajustar o conteúdo de um blog
                            para melhor atendê-la. Ao estudar o público atual de um blog, é possível descobrir quais são
                            os interesses, necessidades e expectativas dos leitores, o que permite desenvolver um
                            conteúdo mais relevante e atrativo.</p>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!--Final da pesquisa-->
        <!--Inicio dashboard parte 1-->
        <!--Inicio do gráfico-->
        <div class="dashboard1" id="resultados">
            <div class="chart-container">
                <div class="tituloDash">
                    <h1>Por gênero</h1>
                    <p>Quantas pessoas preferem os gêneros</p>
                </div>

                <div class="grafico">
                    <canvas class="chart" id="myChart"></canvas>
                </div>
            </div>

            <!--Final do gráfico-->
            <!--Inicio das kpis-->
            <div class="kpi">
                <h1>Dados gerais</h1>
                <div class="maxMin">
                    <div class="maiorGenero"></div>
                    <div class="menorGenero"></div>
                </div>
                <div class="base">
                    <div class="card1"></div>
                    <div class="card2"></div>
                </div>
                <div class="base">
                    <div class="card1"></div>
                    <div class="card2"></div>
                </div>
            </div>
            <!--Final das kpis-->
        </div>
        <!--Final dashboard parte 1-->
        <!--Inicio da dashboard parte 2-->
        <div class="dashboard2">
            <div class="texto">
                <div class="lev">
                    <h1>Por gênero</h1>
                    <p>Quantas pessoas preferem
                        os gêneros</p>
                </div>
            </div>
            <div class="chart-container">
                <canvas class="chart" id="myChart2"></canvas>
            </div>

        </div>
        <!--Final da dashboard parte 2-->
</body>

</html>
<script>
    /*   const labels = [
          'Terror',
          'Drama',
          'Romance',
          'Comédia',
          'Ficção'
      ];
  
  
  
      const dataBar = {
          labels: labels,
          datasets: [{
              label: 'Quantidades de votos',
              backgroundColor: '#FF0051',
              borderColor: '#000000',
              data: [22, 24, 27, 23, 20],
          }
          ]
      }
      const data = {
          
          datasets: [{
              label: 'Votos',
              data: [300, 50, 100, 50],
              backgroundColor: [
                  '#EB385E',
                  '#F10A53',
                  '#F9C0D2',
                  '#FF8A98',
                  '#BD003C'
                  
              ],
              hoverOffset: 5
          }],
          labels: [
              'Terror',
              'Drama',
              'Romance',
              'Comédia',
              'Ficção'
          ]
      };
  
  
  
  
      const configBar = {
          type: 'bar',
          data: dataBar,
          options: {}
      };
  
      const configLine = {
          type: 'doughnut',
          data: data,
      };
  
  
      const myChart = new Chart(
          document.getElementById('myChart'),
          configBar
      );
  
      const myChart2 = new Chart(
          document.getElementById('myChart2'),
          configLine
      );
  
   */
    //---------------------------------------------------------- inicio da api Web---------------------------------------
    function cadastrar() {
        //        aguardar();

        //Recupere o valor da nova input pelo nome do id
        // Agora vá para o método fetch logo abaixo

        var generoVar = inp_genero.value;
        var autorVar = inp_autor.value;
        var qtdVar = inp_qtd.value;
        /* var nomeVar = document.getElementById('inp_nome').value;
        var emailVar = document.getElementById('inp_email').value;
        var assuntoVar = document.getElementById('inp_assunto').value;
     */

        if (generoVar == "") {
            alert("(Digite seu genêro favorito !)");
            inp_genero.value = "";
            cardErro.style.display = "block"
            mensagem_erro.innerHTML = "(Mensagem de erro para todos os campos em branco)";
            return false;

        } else if (autorVar == "") {
            alert("(Digite seu autor favorito!)");
            inp_autor.value = "";
            return false;
        }
        else if (qtdVar == "") {
            alert("(Digite a quantidade mensal!)");
            inp_qtd.value = "";
            return false;
        }
        console.log("Final das validações")



        // Enviando o valor da nova input
        fetch("/pesquisa/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                generoServer: generoVar,
                autorServer: autorVar,
                qtdServer: qtdVar
            })
        }).then(function (resposta) {

            console.log("quero ver essa resposta: ", resposta);
            if (resposta.ok) {
                inp_genero.value = "";
                inp_autor.value = "";
                inp_qtd.value = "";
                mensagem_erro.innerHTML = "Cadastro realizado com sucesso! Redirecionando para tela de Login...";



            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
                alert(emailVar)
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

        return false;
    }

    function sumirMensagem() {
        cardErro.style.display = "none"
    }
    /*********************Plotar gráfico - api da Júlia ***********************/
    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models


    function obterDadosGrafico(idLivro) {


        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idLivro}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idLivro);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idLivro) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Quantidades de votos',
                data: [],
                fill: false,
                backgroundColor: '#FF0051',
                borderColor: '#000000',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.genero);
            dados.datasets[0].data.push(registro.genero);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
            options: {}
        };
        // Adicionando gráfico criado em div na tela
        const myChart = new Chart(
            document.getElementById('myChart'),
            config
        );

        setTimeout(() => atualizarGrafico(idLivro, dados, myChart), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idLivro, dados, myChart) {



        fetch(`/medidas/tempo-real/${idLivro}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    obterdados(idLivro);
                    // alertar(novoRegistro, idLivro);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    let avisoCaptura = document.getElementById(`avisoCaptura${idLivro}`)
                    avisoCaptura.innerHTML = ""


                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")

                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].genero); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[0].qtdLivrosMes); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idLivro, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idLivro, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

</script>